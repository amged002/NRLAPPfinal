@model NRLApp.Models.ObstacleDetailsVm

@{
    ViewData["Title"] = "Hinderdetaljer";
    var title = string.IsNullOrWhiteSpace(Model.ObstacleName)
        ? $"Hinder #{Model.Id}"
        : Model.ObstacleName;
}

<h2>@title</h2>

<div class="mb-3">
    <span class="badge @(Model.IsDraft ? "bg-secondary" : "bg-success")">
        @(Model.IsDraft ? "Utkast" : "Innsendt")
    </span>
</div>

<div class="row">
    <div class="col-md-4">
        <dl class="row">
            <dt class="col-sm-5">ID</dt>
            <dd class="col-sm-7">@Model.Id</dd>

            <dt class="col-sm-5">Hinder</dt>
            <dd class="col-sm-7">
                @(string.IsNullOrWhiteSpace(Model.ObstacleName) ? "(uten navn)" : Model.ObstacleName)
            </dd>

            <dt class="col-sm-5">Høyde (m)</dt>
            <dd class="col-sm-7">@((Model.HeightMeters?.ToString() ?? "-"))</dd>

            <dt class="col-sm-5">Registrert</dt>
            <dd class="col-sm-7">
                @Model.CreatedUtc.ToLocalTime().ToString("yyyy-MM-dd HH:mm")
            </dd>

            <dt class="col-sm-5">Beskrivelse</dt>
            <dd class="col-sm-7">
                @(string.IsNullOrWhiteSpace(Model.Description) ? "-" : Model.Description)
            </dd>
        </dl>

        <a asp-controller="Obstacle"
           asp-action="List"
           class="btn btn-outline-secondary">
            Tilbake til liste
        </a>
    </div>

    <div class="col-md-8">
        <h5>Plassering på kart</h5>

        <!-- Leaflet CSS -->
        <link rel="stylesheet"
              href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
              integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
              crossorigin="" />

        <div id="map" style="height: 400px; border-radius: 6px; border: 1px solid #ccc;"></div>

        <!-- Leaflet JS -->
        <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
                integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
                crossorigin=""></script>

        <script>
            // GeoJSON som ble lagret i databasen
            const geo = @Html.Raw(string.IsNullOrWhiteSpace(Model.GeoJson) ? "{}" : Model.GeoJson);

            const map = L.map('map');

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19
            }).addTo(map);

            let featureLayer = null;

            try {
                featureLayer = L.geoJSON(geo).addTo(map);

                const bounds = featureLayer.getBounds();
                if (bounds.isValid()) {
                    map.fitBounds(bounds, { padding: [20, 20] });
                } else {
                    // Fallback – zoom til Norge-ish
                    map.setView([64.5, 11.0], 4);
                }
            } catch (e) {
                console.error("Klarte ikke å lese GeoJSON:", e);
                map.setView([64.5, 11.0], 4);
            }
        </script>
    </div>
</div>
