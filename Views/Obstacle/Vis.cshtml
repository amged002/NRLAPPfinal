@using NRLApp.Models
@using NRLApp.Models.Obstacles
@model ObstacleDetailsVm

@{
    ViewData["Title"] = "Hinderdetaljer";
    var title = string.IsNullOrWhiteSpace(Model.ObstacleName)
        ? $"Hinder #{Model.Id}"
        : Model.ObstacleName;

    var badgeClass = Model.IsDraft ? "bg-secondary" : "bg-warning text-dark";
    var badgeText = Model.IsDraft ? "Utkast" : "Avventer";

    if (!Model.IsDraft)
    {
        switch (Model.ReviewStatus)
        {
            case ObstacleStatus.Approved:
                badgeClass = "bg-success";
                badgeText = "Godkjent";
                break;
            case ObstacleStatus.Rejected:
                badgeClass = "bg-danger";
                badgeText = "Avvist";
                break;
        }
    }
}

<h2>@title</h2>

<div class="mb-3">
    <span class="badge @badgeClass">@badgeText</span>
</div>

@if (TempData["StatusMessage"] is string statusMessage)
{
    <div class="alert alert-success">@statusMessage</div>
}

<div class="row">
    <div class="col-md-4">
        <dl class="row">
            <dt class="col-sm-5">ID</dt>
            <dd class="col-sm-7">@Model.Id</dd>

            <dt class="col-sm-5">Hinder</dt>
            <dd class="col-sm-7">
                @(string.IsNullOrWhiteSpace(Model.ObstacleName) ? "(uten navn)" : Model.ObstacleName)
            </dd>

            <dt class="col-sm-5">Høyde (m)</dt>
            <dd class="col-sm-7">@((Model.HeightMeters?.ToString() ?? "-"))</dd>

            <dt class="col-sm-5">Registrert</dt>
            <dd class="col-sm-7">
                @Model.CreatedUtc.ToLocalTime().ToString("yyyy-MM-dd HH:mm")
            </dd>

            <dt class="col-sm-5">Beskrivelse</dt>
            <dd class="col-sm-7">
                @(string.IsNullOrWhiteSpace(Model.Description) ? "-" : Model.Description)
            </dd>

            <dt class="col-sm-5">Saksstatus</dt>
            <dd class="col-sm-7">@badgeText</dd>

            <dt class="col-sm-5">Innmeldt av</dt>
            <dd class="col-sm-7">@(string.IsNullOrWhiteSpace(Model.CreatedByUserName) ? "-" : Model.CreatedByUserName)</dd>

            <dt class="col-sm-5">Behandlet av</dt>
            <dd class="col-sm-7">@(string.IsNullOrWhiteSpace(Model.AssignedToUserName) ? "-" : Model.AssignedToUserName)</dd>

            <dt class="col-sm-5">Saks-kommentar</dt>
            <dd class="col-sm-7">@(string.IsNullOrWhiteSpace(Model.ReviewComment) ? "-" : Model.ReviewComment)</dd>
        </dl>

        <a asp-controller="Obstacle"
           asp-action="List"
           class="btn btn-outline-secondary">
            Tilbake til liste
        </a>

        <!-- GODKJENN / AVVIS – KUN FOR ADMIN + APPROVER -->
        @if (!Model.IsDraft && (User.IsInRole("Admin") || User.IsInRole("Approver")))
        {
            <div class="card mt-4">
                <div class="card-body">
                    <h5 class="card-title">Godkjenn eller avvis</h5>
                    <p class="card-text">
                        Oppdater status og legg ved en kommentar til den som meldte inn hinderet.
                    </p>

                    <form asp-controller="Obstacle" asp-action="Approve" method="post" id="review-form">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="id" value="@Model.Id" />

                        <div class="mb-3">
                            <label class="form-label" for="reviewComment">Kommentar</label>
                            <textarea class="form-control" id="reviewComment" name="reviewComment" rows="3">@Model.ReviewComment</textarea>
                        </div>

                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-success">Godkjenn</button>

                            <button type="submit"
                                    class="btn btn-danger"
                                    formaction="@Url.Action("Reject", "Obstacle")">
                                Avvis
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        }
    </div>

    <div class="col-md-8">
        <h5>Plassering på kart</h5>

        <!-- Leaflet CSS -->
        <link rel="stylesheet"
              href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
              integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
              crossorigin="" />

        <div id="map" style="height: 400px; border-radius: 6px; border: 1px solid #ccc;"></div>

        <!-- Leaflet JS -->
        <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
                integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
                crossorigin=""></script>

        <script>
            // GeoJSON som ble lagret i databasen
            const geo = JSON.parse(`@Html.Raw(string.IsNullOrWhiteSpace(Model.GeoJson) ? "{}" : Model.GeoJson)`);

            const map = L.map('map');

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19
            }).addTo(map);

            let featureLayer = null;

            try {
                featureLayer = L.geoJSON(geo).addTo(map);

                const bounds = featureLayer.getBounds();
                if (bounds.isValid()) {
                    map.fitBounds(bounds, { padding: [20, 20] });
                } else {
                    map.setView([64.5, 11.0], 4);
                }
            } catch (e) {
                console.error("Klarte ikke å lese GeoJSON:", e);
                map.setView([64.5, 11.0], 4);
            }
        </script>
    </div>
</div>
