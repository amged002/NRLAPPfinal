@{
    ViewData["Title"] = "Registrer område";
}

<div class="screen">
    <h2>REGISTRER OMRÅDE</h2>

    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger">
            @TempData["Error"]
        </div>
    }

    <form asp-action="Area" method="post">
        @Html.AntiForgeryToken()

        <div class="map-and-tools">
            <!-- KART -->
            <div id="map" class="map-frame"></div>

            <!-- VERKTØY -->
            <aside class="tools">
                <div class="tool-title">VERKTØY</div>

                <button type="button" class="tool-btn" id="btnMarker">
                    Markør
                </button>

                <button type="button" class="tool-btn" id="btnLine">
                    Linje
                </button>

                <button type="button" class="tool-btn danger" id="btnClear">
                    Nullstill
                </button>
            </aside>
        </div>

        <!-- GEOJSON SENDES TIL CONTROLLEREN -->
        <input type="hidden" id="geoJson" name="geoJson" />

        <div class="actions actions-center mt-4">
            <button type="submit" class="btn btn-primary btn-lg px-5">
                Gå videre
            </button>
        </div>
    </form>
</div>

@section Scripts {
    <!-- Leaflet (ta bort hvis dette allerede lastes i _Layout) -->
    <link rel="stylesheet"
          href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>

    <script>
        // -------------------------
        // KARTOPPSETT – Leaflet default (drag uten noe "hold inn"-tull)
        // -------------------------
        var map = L.map('map').setView([58.146, 7.995], 12); // Kristiansand-ish

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; OpenStreetMap'
        }).addTo(map);

        // Lag for det vi tegner
        var drawnLayer = L.featureGroup().addTo(map);

        // Current mode: "marker" | "line"
        var mode = "marker";

        var marker = null;
        var line = null;
        var linePoints = [];
        var lineVertices = []; // små punkt-markører på linje

        // -------------------------
        // HJELPEFUNKSJONER
        // -------------------------
        function setMode(newMode) {
            mode = newMode;
            document.querySelectorAll('.tools .tool-btn').forEach(btn => btn.classList.remove('active'));
            if (newMode === "marker") document.getElementById('btnMarker').classList.add('active');
            if (newMode === "line") document.getElementById('btnLine').classList.add('active');
        }

        function updateGeoJsonField() {
            var gj = drawnLayer.toGeoJSON();
            document.getElementById('geoJson').value = JSON.stringify(gj);
        }

        function clearMarker() {
            if (marker) {
                drawnLayer.removeLayer(marker);
                marker = null;
            }
        }

        function resetLine() {
            if (line) {
                drawnLayer.removeLayer(line);
                line = null;
            }
            linePoints = [];
            lineVertices.forEach(v => drawnLayer.removeLayer(v));
            lineVertices = [];
        }

        function clearAll() {
            clearMarker();
            resetLine();
            updateGeoJsonField();
        }

        function addLineVertex(latlng) {
            var v = L.circleMarker(latlng, {
                radius: 6,
                color: '#003E7E',
                weight: 2,
                fillColor: '#ffffff',
                fillOpacity: 1.0
            }).addTo(drawnLayer);
            lineVertices.push(v);
            linePoints.push(latlng);
        }

        // -------------------------
        // CLICK-HÅNDTERING PÅ KART
        // -------------------------
        map.on('click', function (e) {
            var latlng = e.latlng;

            if (mode === "marker") {
                // bare én markør om gangen
                clearMarker();
                resetLine();
                marker = L.marker(latlng).addTo(drawnLayer);
            }
            else if (mode === "line") {
                clearMarker();

                addLineVertex(latlng);

                if (line) {
                    drawnLayer.removeLayer(line);
                }
                line = L.polyline(linePoints, {
                    color: '#003E7E',   // tydelig blå linje
                    weight: 4,
                    opacity: 1.0
                }).addTo(drawnLayer);
            }

            updateGeoJsonField();
        });

        // -------------------------
        // GEOLOCATION ("Du er her") med egen stil
        // -------------------------
        function tryLocate() {
            if (!navigator.geolocation) return;

            navigator.geolocation.getCurrentPosition(function (pos) {
                var lat = pos.coords.latitude;
                var lng = pos.coords.longitude;
                var here = L.latLng(lat, lng);

                map.setView(here, 14);

                // "Du er her" – rød/hvit sirkel, annerledes enn hinder-markør
                var youMarker = L.circleMarker(here, {
                    radius: 8,
                    color: '#D7261E',
                    weight: 3,
                    fillColor: '#ffffff',
                    fillOpacity: 1.0
                }).addTo(map);

                youMarker.bindPopup("Du er her").openPopup();
            },
            function (err) {
                console.warn("Geolocation feilet:", err.message);
            });
        }

        tryLocate();

        // -------------------------
        // KOBLE KNAPPER
        // -------------------------
        document.getElementById('btnMarker').addEventListener('click', function () {
            setMode("marker");
        });

        document.getElementById('btnLine').addEventListener('click', function () {
            setMode("line");
        });

        document.getElementById('btnClear').addEventListener('click', function () {
            clearAll();
        });

        // Startmodus = markør
        setMode("marker");
    </script>
}
