@{
    ViewData["Title"] = "Registrer område";
}

<div class="screen">
    <h2>REGISTRER OMRÅDE</h2>

    <form asp-action="Area" method="post" class="map-form" id="areaForm">
        <input type="hidden" name="geoJson" id="geoJson" />

        <div class="map-and-tools">
            <div id="map" class="map-box"></div>

            <div class="tools">
                <div class="tool-title">VERKTØY</div>
                <button type="button" id="btnPoint" class="tool-btn">Markør</button>
                <button type="button" id="btnLine" class="tool-btn">Linje</button>
                <button type="button" id="btnPoly" class="tool-btn">Område</button>
                <hr />
                <button type="button" id="btnUndo" class="tool-btn secondary">Angre siste</button>
                <button type="button" id="btnClear" class="tool-btn danger">Nullstill</button>
            </div>
        </div>

        <div class="actions">
            <button type="submit" class="primary">Gå videre</button>
        </div>
    </form>

    @if (TempData["Error"] is string e)
    {
        <div class="text-danger mt-2">@e</div>
    }
</div>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>

<style>
    .screen {
        width: 100%;
        max-width: none;
        margin: 0;
        padding: 30px 40px 40px 40px;
        background: white;
        box-sizing: border-box;
    }

    .screen h2 {
        text-align: center;
        font-size: 32px;
        margin-bottom: 20px;
    }

    .map-form {
        width: 100%;
        margin: 0 auto;
    }

    .map-and-tools {
        display: grid;
        grid-template-columns: minmax(0, 1fr) 280px;
        gap: 24px;
        align-items: flex-start;
    }

    .map-box {
        width: 100%;
        height: calc(100vh - 260px);
        min-height: 550px;
        border-radius: 16px;
        overflow: hidden;
    }

    .tools {
        width: 100%;
        max-width: 280px;
        background: #f3f3f3;
        border-radius: 16px;
        padding: 18px 16px;
        box-sizing: border-box;
    }

    .tool-title {
        font-weight: 800;
        margin-bottom: 14px;
        font-size: 18px;
    }

    .tool-btn {
        display: block;
        width: 100%;
        margin-bottom: 10px;
        padding: 12px 14px;
        border: 0;
        background: #ffffff;
        border-radius: 10px;
        cursor: pointer;
        font-size: 16px;
        font-weight: 600;
        text-align: left;
        box-shadow: 0 1px 3px rgba(0,0,0,0.06);
    }

    .tool-btn:hover {
        background: #e9e9e9;
    }

    .tool-btn.secondary {
        background: #ffffff;
    }

    .tool-btn.danger {
        background: #fff5f5;
    }

    .tool-btn.danger:hover {
        background: #ffe1e1;
    }

    .actions {
        margin-top: 26px;
        text-align: center;
    }

    .primary {
        background: #1f6f2e;
        color: #fff;
        border: 0;
        border-radius: 10px;
        padding: 13px 28px;
        font-size: 18px;
        font-weight: 700;
        cursor: pointer;
        box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    }

    .primary:hover {
        filter: brightness(0.95);
    }

    @@media (max-width: 1100px) {
        .map-and-tools {
            grid-template-columns: 1fr;
        }

        .tools {
            max-width: 100%;
        }

        .map-box {
            height: 500px;
        }
    }
</style>

<script>
    (function () {
        const map = L.map('map').setView([58.1467, 7.9956], 14);
        L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png',
            { maxZoom: 19, attribution: '&copy; OpenStreetMap contributors' }).addTo(map);

        const drawn = new L.FeatureGroup();
        map.addLayer(drawn);

        const drawControl = new L.Control.Draw({
            draw: {
                marker: {},
                polyline: {
                    shapeOptions: { color: '#2c6bed', weight: 3 }
                },
                polygon: {
                    allowIntersection: false,
                    shapeOptions: { color: '#2c6bed', weight: 2, fillOpacity: 0.15 }
                },
                circle: false,
                rectangle: false,
                circlemarker: false
            },
            edit: { featureGroup: drawn }
        });

        function startDraw(mode) {
            let drawer;
            if (mode === "marker") {
                drawer = new L.Draw.Marker(map, drawControl.options.draw.marker);
            } else if (mode === "polyline") {
                drawer = new L.Draw.Polyline(map, drawControl.options.draw.polyline);
            } else if (mode === "polygon") {
                drawer = new L.Draw.Polygon(map, drawControl.options.draw.polygon);
            }
            if (drawer) {
                drawer.enable();
            }
        }

        // Kun én markør av gangen
        map.on(L.Draw.Event.CREATED, function (e) {
            if (e.layerType === 'marker') {
                drawn.eachLayer(l => {
                    if (l instanceof L.Marker) {
                        drawn.removeLayer(l);
                    }
                });
            }
            drawn.addLayer(e.layer);
        });

        document.getElementById('btnPoint').onclick = () => startDraw("marker");
        document.getElementById('btnLine').onclick = () => startDraw("polyline");
        document.getElementById('btnPoly').onclick = () => startDraw("polygon");

        document.getElementById('btnUndo').onclick = () => {
            const layers = Object.values(drawn._layers);
            if (layers.length > 0) {
                const last = layers[layers.length - 1];
                drawn.removeLayer(last);
            }
        };

        document.getElementById('btnClear').onclick = () => drawn.clearLayers();

        // GeoJson
        document.getElementById('areaForm').addEventListener('submit', function (e) {
            const layers = drawn.getLayers();
            if (layers.length === 0) {
                alert("Du må plassere en markør, tegne en linje eller et område.");
                e.preventDefault();
                return;
            }

            const fc = drawn.toGeoJSON();
            document.getElementById('geoJson').value = JSON.stringify(fc);
        });

        setTimeout(() => map.invalidateSize(), 80);
        window.addEventListener('resize', () => {
            setTimeout(() => map.invalidateSize(), 50);
        });
    })();
</script>
