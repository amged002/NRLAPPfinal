@using System.Text.Json
@model IEnumerable<NRLApp.Models.ObstacleListItem>
@{
    ViewData["Title"] = "Kart – registrerte hindre";

    // Tving camelCase i JSON så JS kan bruke x.centerLat osv.
    var json = JsonSerializer.Serialize(
        Model ?? Enumerable.Empty<NRLApp.Models.ObstacleListItem>(),
        new JsonSerializerOptions { PropertyNamingPolicy = JsonNamingPolicy.CamelCase }
    );
}

<div class="screen">
    <h2>KART – REGISTRERTE HINDRE</h2>
    <div class="map-frame">
        <div id="map" style="width:100%;height:560px;border-radius:10px;"></div>
    </div>
</div>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    (function () {
        // Data fra server (camelCase)
        const data = @Html.Raw(json);

        // Default: Kristiansand
        const defaultCenter = [58.14671, 7.99560];
        const center = (data && data.length > 0)
            ? [Number(data[0].centerLat), Number(data[0].centerLng)]
            : defaultCenter;
        const zoom = (data && data.length > 0) ? 12 : 6;

        // Init kart
        const map = L.map('map', { zoomControl: true }).setView(center, zoom);

        // VIKTIG: legg alltid til tile layer (bruker ett domene for færre nettverks-issues)
        L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        const latLngs = [];
        if (data && data.length > 0) {
            data.forEach(x => {
                const lat = Number(x.centerLat);
                const lng = Number(x.centerLng);
                const radius = Number(x.radiusMeters);

                if (Number.isFinite(lat) && Number.isFinite(lng)) {
                    const ll = [lat, lng];
                    latLngs.push(ll);

                    // Blå radius-sirkel
                    L.circle(ll, {
                        radius: Number.isFinite(radius) ? radius : 30,
                        color: '#2c6bed',
                        fillColor: '#2c6bed',
                        fillOpacity: 0.15,
                        weight: 2
                    }).addTo(map);

                    // Liten prikk i midten
                    L.circleMarker(ll, { radius: 3, color: '#2c6bed', weight: 2, fillOpacity: 1 }).addTo(map);
                }
            });
        }

        if (latLngs.length > 0) {
            const bounds = L.latLngBounds(latLngs);
            map.fitBounds(bounds.pad(0.2));
        }

        // Tving Leaflet til å beregne størrelse etter render/redirect
        setTimeout(() => map.invalidateSize(), 100);
    })();
</script>
