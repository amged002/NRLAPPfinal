@{
    ViewData["Title"] = "Registrer område";
}

<div class="screen screen-map">
    <h2>REGISTRER OMRÅDE</h2>

    <form asp-action="Area" method="post" class="map-form" id="areaForm">
        <input type="hidden" name="geoJson" id="geoJson" />

        <div class="map-and-tools">
            <div id="map" class="map-box"></div>

            <div class="tools">
                <div class="tool-title">VERKTØY</div>
                <button type="button" id="btnPoint" class="tool-btn">Markør</button>
                <button type="button" id="btnLine" class="tool-btn">Linje</button>
                <button type="button" id="btnPoly" class="tool-btn">Område</button>
                <hr />
                <button type="button" id="btnUndo" class="tool-btn secondary">Angre siste</button>
                <button type="button" id="btnClear" class="tool-btn danger">Nullstill</button>
            </div>
        </div>
        
        <div class="actions actions-center">
            <button type="submit" class="primary">Gå videre</button>
        </div>
    </form>

    @if (TempData["Error"] is string e)
    {
        <div class="text-danger mt-2">@e</div>
    }
</div>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>

<script>
    (function () {
        // Standard-posisjon (Kristiansand) hvis geolokasjon ikke funker
        const defaultCenter = [58.1467, 7.9956];
        const defaultZoom = 14;

        // Opprett kartet med default view først
        const map = L.map('map').setView(defaultCenter, defaultZoom);
        L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png',
            { maxZoom: 19, attribution: '&copy; OpenStreetMap contributors' }).addTo(map);

        // Forsøk å bruke nettleserens geolokasjon (som Google Maps)
        if ("geolocation" in navigator) {
            navigator.geolocation.getCurrentPosition(
                function (pos) {
                    const userLat = pos.coords.latitude;
                    const userLng = pos.coords.longitude;
                    const userLatLng = [userLat, userLng];

                    // Flytt kartet til brukerens posisjon
                    map.setView(userLatLng, 15);

                    // Liten markør for "du er her"
                    L.circleMarker(userLatLng, {
                        radius: 6,
                        color: '#D7261E',
                        fillColor: '#D7261E',
                        fillOpacity: 0.9,
                        weight: 2
                    })
                        .addTo(map)
                        .bindPopup("Du er her")
                        .openPopup();
                },
                function (err) {
                    console.warn("Geolocation feilet eller ble nektet:", err);
                    // gjør ingenting → vi beholder defaultCenter
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 60000
                }
            );
        }

        const drawn = new L.FeatureGroup();
        map.addLayer(drawn);

        const drawControl = new L.Control.Draw({
            draw: {
                marker: {},
                polyline: {
                    shapeOptions: { color: '#2c6bed', weight: 3 }
                },
                polygon: {
                    allowIntersection: false,
                    shapeOptions: { color: '#2c6bed', weight: 2, fillOpacity: 0.15 }
                },
                circle: false,
                rectangle: false,
                circlemarker: false
            },
            edit: { featureGroup: drawn }
        });

        function startDraw(mode) {
            let drawer;
            if (mode === "marker") {
                drawer = new L.Draw.Marker(map, drawControl.options.draw.marker);
            } else if (mode === "polyline") {
                drawer = new L.Draw.Polyline(map, drawControl.options.draw.polyline);
            } else if (mode === "polygon") {
                drawer = new L.Draw.Polygon(map, drawControl.options.draw.polygon);
            }
            if (drawer) {
                drawer.enable();
            }
        }

        // Kun én markør av gangen
        map.on(L.Draw.Event.CREATED, function (e) {
            if (e.layerType === 'marker') {
                drawn.eachLayer(l => {
                    if (l instanceof L.Marker) {
                        drawn.removeLayer(l);
                    }
                });
            }
            drawn.addLayer(e.layer);
        });

        document.getElementById('btnPoint').onclick = () => startDraw("marker");
        document.getElementById('btnLine').onclick = () => startDraw("polyline");
        document.getElementById('btnPoly').onclick = () => startDraw("polygon");

        document.getElementById('btnUndo').onclick = () => {
            const layers = Object.values(drawn._layers);
            if (layers.length > 0) {
                const last = layers[layers.length - 1];
                drawn.removeLayer(last);
            }
        };

        document.getElementById('btnClear').onclick = () => drawn.clearLayers();

        // GeoJson
        document.getElementById('areaForm').addEventListener('submit', function (e) {
            const layers = drawn.getLayers();
            if (layers.length === 0) {
                alert("Du må plassere en markør, tegne en linje eller et område.");
                e.preventDefault();
                return;
            }

            const fc = drawn.toGeoJSON();
            document.getElementById('geoJson').value = JSON.stringify(fc);
        });

        setTimeout(() => map.invalidateSize(), 80);
        window.addEventListener('resize', () => {
            setTimeout(() => map.invalidateSize(), 50);
        });
    })();
</script>

